name: CD - Deploy to AWS

on:
  workflow_run:
    workflows: ["CI - Test"]
    types:
      - completed

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    # Run only if CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for OIDC (recommended over access keys)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # ==========================================
      # 1. DEPLOY FRONTEND
      # ==========================================
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Build React App
        run: |
          cd frontend/
          npm ci
          npm run build
      
      - name: Deploy static files to S3
        run: |
          aws s3 sync ./frontend/dist s3://${{ secrets.AWS_S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable"
      
      - name: Invalidate CloudFront Cache
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"
            echo "✅ CloudFront cache invalidated"
          else
            echo "ℹ️ Skipping CloudFront invalidation (no distribution ID configured)"
          fi
      
      # ==========================================
      # 2. DEPLOY BACKEND TO ECR
      # ==========================================
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: cdpi-pass/backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Build for AMD64 (standard for most ECS instances)
          docker buildx build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -f backend/Dockerfile \
            ./backend \
            --push
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
      
      # ==========================================
      # 3. UPDATE ECS TASK DEFINITIONS & DEPLOY
      # ==========================================
      
      # Backend Service
      - name: Render Backend Task Definition
        id: backend-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .ecs/backend-task.json
          container-name: backend
          image: ${{ steps.build-image.outputs.image }}
      
      - name: Deploy Backend Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.backend-task-def.outputs.task-definition }}
          service: backend-service
          cluster: cdpi-pass-cluster
          wait-for-service-stability: true
      
      # Worker Service
      - name: Render Worker Task Definition
        id: worker-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .ecs/worker-task.json
          container-name: worker
          image: ${{ steps.build-image.outputs.image }}
      
      - name: Deploy Worker Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.worker-task-def.outputs.task-definition }}
          service: worker-service
          cluster: cdpi-pass-cluster
          wait-for-service-stability: true
      
      # Beat Service
      - name: Render Beat Task Definition
        id: beat-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .ecs/beat-task.json
          container-name: beat
          image: ${{ steps.build-image.outputs.image }}
      
      - name: Deploy Beat Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.beat-task-def.outputs.task-definition }}
          service: beat-service
          cluster: cdpi-pass-cluster
          wait-for-service-stability: true
      
      # ==========================================
      # 4. DEPLOYMENT NOTIFICATION (Optional)
      # ==========================================
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Frontend: s3://${{ secrets.AWS_S3_BUCKET_NAME }}"
          echo "Backend Image: ${{ steps.build-image.outputs.image }}"
          echo "Services updated: backend-service, worker-service, beat-service"